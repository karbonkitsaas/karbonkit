const SUPABASE_URL="https://hcdnbrmepzyzqakvdkkc.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjZG5icm1lcHp5enFha3Zka2tjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MDkyNjcsImV4cCI6MjA3NDE4NTI2N30.gzDEOvKIKKZHtBndbPUd7TGv40Zsn4QEBfu8d6DSJS4";document.addEventListener("alpine:init",()=>{Alpine.data("carbonCalculator",()=>({isAuthenticated:!1,user:null,lang:"en",currentView:"dashboard",isLoadingData:!1,showConfirmExport:!1,runExport:()=>{},showOnboarding:!0,showTutorial:!1,tutorialStep:1,onboarding:{step:1,industry:"Palm Oil",exportsToEU:"No",employees:"<50"},pastCalculations:[],pastReports:[],dieselEntries:[],activeTab:"manual",newEntry:{description:"",liters:0},errorMessage:"",totalLiters:0,co2eTons:0,cbam:{exportVolume:0,taxEur:0,taxRmy:0,offsetCost:0,scope3Preview:0,riskScore:{en:"Low",my:"Rendah",class:"risk-low"}},eudr:{geolocation:"No",certification:"None",landUse:"No Deforestation",riskScore:{en:"High",my:"Tinggi",class:"risk-high"},mitigation:{en:"Obtain MSPO certification",my:"Dapatkan pensijilan MSPO"}},simulationSummary:{total:0,highRisk:0,mediumRisk:0,lowRisk:0},simulationHistory:[],filterRisk:"",filterDate:"",currentPage:1,pageSize:10,premiumUnlocked:!1,subscriptionExpiry:null,showPaymentSuccess:!1,vcmCredits:100,vcmPrice:50,vcmTrades:[],SUPABASE_URL:"https://hcdnbrmepzyzqakvdkkc.supabase.co",SUPABASE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjZG5icm1lcHp5enFha3Zka2tjIiwicm9zZSI6ImFub24iLCJpYXQiOjE3NTg2MDkyNjcsImV4cCI6MjA3NDE4NTI2N30.gzDEOvKIKKZHtBndbPUd7TGv40Zsn4QEBfu8d6DSJS4",async init(){this.isLoadingData=!0;try{await this.fetchCalculations(),await this.fetchSimulations(),await this.fetchReports(),this.initTooltips()}catch(i){this.errorMessage="en"===this.lang?"Failed to load data":"Gagal memuat data",console.error(i)}finally{this.isLoadingData=!1}},setLang(i){this.lang=i,console.log("Language set to:",i),this.$nextTick(()=>{document.documentElement.lang=i})},async finishOnboarding(){this.showOnboarding=!1,"Palm Oil"===this.onboarding.industry&&(this.newEntry.description="Palm Oil Milling"),this.showTutorial=!0,this.tutorialStep=1},nextTutorialStep(){this.tutorialStep<3?this.tutorialStep++:(this.showTutorial=!1,this.saveUserProgress())},async saveUserProgress(){try{const{error:i}=await this.supabase.from("user_progress").upsert({user_id:this.user.id,tutorial_completed:!0});i&&console.error("Error saving user progress:",i)}catch(i){console.error("Unexpected error saving user progress:",i)}},initTooltips(){tippy("[data-tippy-content]",{theme:"light",animation:"fade",duration:200})},async addEntry(){if(this.newEntry.liters<=0)return this.errorMessage="en"===this.lang?"Invalid input: Liters must be positive":"Input tidak sah: Liter mesti positif",void setTimeout(()=>this.errorMessage="",3e3);this.isLoadingData=!0;try{const i=2.68*this.newEntry.liters/1e3;if(!(await fetch(`${this.SUPABASE_URL}/rest/v1/emissions`,{method:"POST",headers:{"Content-Type":"application/json",apikey:this.SUPABASE_KEY,Authorization:`Bearer ${this.SUPABASE_KEY}`},body:JSON.stringify({liters:this.newEntry.liters,co2e_tons:i})})).ok)throw new Error("Failed to save entry");this.dieselEntries.push({...this.newEntry,co2eTons:i}),this.totalLiters+=this.newEntry.liters,this.co2eTons+=i,this.pastCalculations.push({...this.newEntry,co2eTons:i,timestamp:(new Date).toISOString()}),this.newEntry={description:"",liters:0}}catch(i){this.errorMessage="en"===this.lang?"Failed to save entry":"Gagal menyimpan entri",console.error(i)}finally{this.isLoadingData=!1}},calculateCbam(){this.cbam.taxEur=100*this.co2eTons*.025,this.cbam.taxRmy=5*this.cbam.taxEur,this.cbam.scope3Preview=1e3*this.cbam.exportVolume*.5/1e3,this.cbam.offsetCost=50*this.co2eTons,this.cbam.riskScore=this.cbam.taxRmy>5e3?{en:"High",my:"Tinggi",class:"risk-high"}:this.cbam.taxRmy<1e3?{en:"Low",my:"Rendah",class:"risk-low"}:{en:"Medium",my:"Sederhana",class:"risk-medium"}},calculateEudr(){"Yes"===this.eudr.geolocation&&"MSPO/RSPO"===this.eudr.certification&&"No Deforestation"===this.eudr.landUse?this.eudr.riskScore={en:"Low",my:"Rendah",class:"risk-low"}:(this.eudr.riskScore={en:"High",my:"Tinggi",class:"risk-high"},this.eudr.mitigation={en:"Obtain MSPO certification",my:"Dapatkan pensijilan MSPO"})},async saveSimulation(){this.isLoadingData=!0;try{const{error:i,status:s}=await this.supabase.from("simulations").insert({volume:this.cbam.exportVolume,cbam_tax_rm:this.cbam.taxRmy,eudr_risk:this.eudr.riskScore.en,mitigation:this.eudr.mitigation.en});i?(this.errorMessage=401===s||403===s?"en"===this.lang?"Unauthorized access. Please check your permissions.":"Akses tidak dibenarkan. Sila semak kebenaran anda.":"en"===this.lang?"Failed to save simulation.":"Gagal menyimpan simulasi.",console.error("Error saving simulation:",i)):alert("en"===this.lang?"Simulation saved successfully!":"Simulasi berjaya disimpan!")}catch(i){this.errorMessage="en"===this.lang?"An unexpected error occurred while saving the simulation.":"Ralat tidak dijangka berlaku semasa menyimpan simulasi.",console.error(i)}finally{this.isLoadingData=!1}},async fetchSimulations(){this.isLoadingData=!0;try{const{data:i,error:s,status:e}=await this.supabase.from("simulations").select("*").order("timestamp",{ascending:!1});s?(this.errorMessage=401===e||403===e?"en"===this.lang?"Unauthorized access. Please check your permissions.":"Akses tidak dibenarkan. Sila semak kebenaran anda.":"en"===this.lang?"Failed to fetch simulations.":"Gagal mengambil simulasi.",console.error("Error fetching simulations:",s)):this.simulationHistory=i}catch(i){this.errorMessage="en"===this.lang?"An unexpected error occurred while fetching simulations.":"Ralat tidak dijangka berlaku semasa mengambil simulasi.",console.error(i)}finally{this.isLoadingData=!1}},async fetchCalculations(){this.isLoadingData=!0;try{const{data:i,error:s,status:e}=await this.supabase.from("emissions").select("*").order("timestamp",{ascending:!1});s?(this.errorMessage=401===e||403===e?"en"===this.lang?"Unauthorized access. Please check your permissions.":"Akses tidak dibenarkan. Sila semak kebenaran anda.":"en"===this.lang?"Failed to fetch calculations.":"Gagal mengambil pengiraan.",console.error("Error fetching calculations:",s)):this.pastCalculations=i}catch(i){this.errorMessage="en"===this.lang?"An unexpected error occurred while fetching calculations.":"Ralat tidak dijangka berlaku semasa mengambil pengiraan.",console.error(i)}finally{this.isLoadingData=!1}},async fetchReports(){this.isLoadingData=!0;try{const{data:i,error:s,status:e}=await this.supabase.from("reports").select("*").order("timestamp",{ascending:!1});s?(this.errorMessage=401===e||403===e?"en"===this.lang?"Unauthorized access. Please check your permissions.":"Akses tidak dibenarkan. Sila semak kebenaran anda.":"en"===this.lang?"Failed to fetch reports.":"Gagal mengambil laporan.",console.error("Error fetching reports:",s)):this.pastReports=i}catch(i){this.errorMessage="en"===this.lang?"An unexpected error occurred while fetching reports.":"Ralat tidak dijangka berlaku semasa mengambil laporan.",console.error(i)}finally{this.isLoadingData=!1}},trends:{cbam:{en:"",my:""},eudr:{en:"",my:""}},async calculateTrends(){try{const i=200*(this.pastCalculations.reduce((i,s)=>i+s.co2eTons,0)/this.pastCalculations.length);this.trends.cbam.en=`Projected CBAM tax increase: RM${i.toFixed(2)}/month`,this.trends.cbam.my=`Anggaran kenaikan cukai CBAM: RM${i.toFixed(2)}/bulan`;const s=this.simulationHistory.filter(i=>"High"===i.eudr_risk).length/this.simulationHistory.length*100;this.trends.eudr.en=s>50?"High risk for 2026 without geolocation and certification.":"Low risk for 2026 with current measures.",this.trends.eudr.my=s>50?"Risiko tinggi untuk 2026 tanpa geolokasi dan pensijilan.":"Risiko rendah untuk 2026 dengan langkah semasa.";const{error:e}=await this.supabase.from("insights").insert({cbam_trend:this.trends.cbam.en,eudr_forecast:this.trends.eudr.en,timestamp:(new Date).toISOString()});e&&console.error("Error saving insights:",e)}catch(i){console.error("Error calculating trends:",i)}},async scanBill(i){this.errorMessage="";const s=i.target.files[0];if(!s)return void(this.errorMessage="en"===this.lang?"No file selected.":"Tiada fail dipilih.");if(["application/pdf","image/jpeg","image/png"].includes(s.type)){this.isLoadingData=!0;try{let i=null;if(window.Tesseract){const e=(await window.Tesseract.recognize(s,"eng")).data.text.match(/(\d+[.,]?\d*)\s*(L|liters)/i);e&&(i=.9*parseFloat(e[1]))}if(!i&&window.ILMU_API){const e=await window.ILMU_API.extractLiters(s);e&&e.liters&&(i=e.liters)}if(!i)return void(this.errorMessage="en"===this.lang?"Could not extract liters from bill.":"Tidak dapat mengekstrak liter dari bil.");this.newEntry.liters=i,this.newEntry.description=s.name;const e=2.68*i/1e3,{error:a}=await this.supabase.from("invoices").insert({filename:s.name,liters:i,co2e_tons:e,timestamp:(new Date).toISOString()});a&&(this.errorMessage="en"===this.lang?"Failed to save invoice.":"Gagal menyimpan invois.")}catch(i){this.errorMessage="en"===this.lang?"Error scanning bill.":"Ralat semasa mengimbas bil."}finally{this.isLoadingData=!1}}else this.errorMessage="en"===this.lang?"Invalid file type.":"Jenis fail tidak sah."},async fetchCredits(){this.isLoadingData=!0;try{this.vcmCredits=100;const{data:i,error:s}=await this.supabase.from("vcm_trades").select("*").order("timestamp",{ascending:!1});s||(this.vcmTrades=i)}catch(i){this.errorMessage="en"===this.lang?"Error fetching credits.":"Ralat mengambil kredit."}finally{this.isLoadingData=!1}},async buyCredits(i){if(this.errorMessage="",!i||i<=0||i>this.vcmCredits)return void(this.errorMessage="en"===this.lang?"Invalid amount.":"Jumlah tidak sah.");this.isLoadingData=!0;const s=i*this.vcmPrice;try{const{error:e}=await this.supabase.from("vcm_trades").insert({tons:i,cost_rm:s,timestamp:(new Date).toISOString()});e?this.errorMessage="en"===this.lang?"Purchase failed.":"Pembelian gagal.":(this.vcmCredits-=i,this.vcmTrades.unshift({tons:i,cost_rm:s,timestamp:(new Date).toISOString()}),alert("en"===this.lang?"Purchase successful!":"Pembelian berjaya!"))}catch(i){this.errorMessage="en"===this.lang?"Error during purchase.":"Ralat semasa pembelian."}finally{this.isLoadingData=!1}},async checkSubscription(){this.isLoadingData=!0;try{const{data:i,error:s}=await this.supabase.from("subscriptions").select("*").order("expiry",{ascending:!1}).limit(1);if(!s&&i&&i.length>0){const s=i[0];this.premiumUnlocked="active"===s.status&&new Date(s.expiry)>new Date,this.subscriptionExpiry=s.expiry}else this.premiumUnlocked=!1,this.subscriptionExpiry=null}catch(i){this.errorMessage="en"===this.lang?"Error checking subscription.":"Ralat semak langganan."}finally{this.isLoadingData=!1}},async subscribe(){this.isLoadingData=!0;try{const i=new Date;i.setMonth(i.getMonth()+1);const{error:s}=await this.supabase.from("subscriptions").insert({status:"active",expiry:i.toISOString()});s?this.errorMessage="en"===this.lang?"Subscription failed.":"Langganan gagal.":(this.premiumUnlocked=!0,this.subscriptionExpiry=i.toISOString(),this.showPaymentSuccess=!0,setTimeout(()=>this.showPaymentSuccess=!1,3e3),alert("en"===this.lang?"Subscription successful!":"Langganan berjaya!"))}catch(i){this.errorMessage="en"===this.lang?"Error during subscription.":"Ralat semasa langganan."}finally{this.isLoadingData=!1}}}))});