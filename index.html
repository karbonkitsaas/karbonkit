<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KarbonKit - SME ESG Scope 1 Emissions</title>
    <style>
        /* Inline PurgeCSS Tailwind */
        body{font-family:'Inter',sans-serif}.tab-active{border-bottom:2px solid #16a34a;color:#16a34a;font-weight:600}.risk-low{background-color:#dcfce7;color:#166534}.risk-medium{background-color:#fef9c3;color:#854d0e}.risk-high{background-color:#fee2e2;color:#991b1b}[x-cloak]{display:none!important}.visible{display:block!important}.bg-white{background-color:#fff}.bg-gray-50{background-color:#f9fafb}.text-gray-800{color:#1f2937}.text-green-600{color:#16a34a}.text-lg{font-size:1.125rem}.font-bold{font-weight:700}.rounded-lg{border-radius:0.5rem}.shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1)}.max-w-6xl{max-width:72rem}.mx-auto{margin-left:auto;margin-right:auto}.p-4{padding:1rem}.sm\:p-6{padding:1.5rem}@media(min-width:640px){.sm\:p-6{padding:1.5rem}}.lg\:p-8{padding:2rem}@media(min-width:1024px){.lg\:p-8{padding:2rem}}.grid{display:grid}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}@media(min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}.gap-8{gap:2rem}.space-y-6> :not([hidden])~ :not([hidden]){margin-top:1.5rem}.space-y-4> :not([hidden])~ :not([hidden]){margin-top:1rem}.flex{display:flex}.justify-end{justify-content:flex-end}.items-center{align-items:center}.flex-col{flex-direction:column}.sm\:flex-row{flex-direction:row}@media(min-width:640px){.sm\:flex-row{flex-direction:row}}.gap-2{gap:0.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.mb-2{margin-bottom:0.5rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.border{border-width:1px}.w-full{width:100%}.w-32{width:8rem}.rounded{border-radius:0.25rem}.disabled\:opacity-50:disabled{opacity:0.5}.text-white{color:#fff}.bg-blue-500{background-color:#3b82f6}.bg-green-500{background-color:#22c55e}.text-red-500{color:#ef4444}.text-gray-700{color:#374151}.font-semibold{font-weight:600}
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="./app.min.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-800" x-data="carbonCalculator" x-init="init(); calculateTrends()" x-cloak>
    <!-- Bilingual Toggle -->
    <div class="flex justify-end p-4">
        <button @click="setLang('en')" :class="{'bg-blue-500 text-white': lang === 'en'}" class="px-4 py-2 border">EN</button>
        <button @click="setLang('bm')" :class="{'bg-blue-500 text-white': lang === 'bm'}" class="px-4 py-2 border">BM</button>
    </div>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Calculator -->
            <div class="bg-white p-6 rounded-lg shadow-lg space-y-6">
                <h2 class="text-xl font-bold">Scope 1â€“3 Calculator</h2>
                <form class="space-y-4">
                    <div>
                        <label for="diesel" class="block">Diesel (liters)</label>
                        <input id="diesel" type="number" class="w-full border p-2" x-model.number="newEntry.liters" data-tippy-content="Enter diesel liters for Scope 1 (2.68 kg CO2e/liter).">
                    </div>
                    <div>
                        <label for="bill-upload" class="block">Upload Diesel Bill (.pdf/.jpg/.png)</label>
                        <input id="bill-upload" type="file" accept=".pdf,.jpg,.png" class="w-full border p-2" @change="scanBill($event)">
                    </div>
                    <button type="button" @click="addEntry()" class="bg-blue-500 text-white px-4 py-2">Add Entry</button>
                    <template x-if="errorMessage">
                        <p class="text-red-500 mt-2" x-text="errorMessage"></p>
                    </template>
                </form>
            </div>

            <!-- Right Column: Reports and Trends -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold">Reports and Trends</h2>
                <ul>
                    <template x-for="report in pastReports" :key="report.id">
                        <li x-text="report.name"></li>
                    </template>
                </ul>

                <!-- CBAM and EUDR Trends -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold">Trends</h3>
                    <p x-text="lang === 'en' ? trends.cbam.en : trends.cbam.my" class="mt-2"></p>
                    <p x-text="lang === 'en' ? trends.eudr.en : trends.eudr.my" class="mt-2"></p>
                </div>

                <!-- CO2e Line Graph -->
                <div class="mt-6">
                    <canvas id="co2eTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- VCM Marketplace Tab -->
        <div class="bg-white p-6 rounded-lg shadow-lg mt-8">
            <h2 class="text-xl font-bold">VCM Marketplace</h2>
            <p class="mb-2" x-text="lang === 'en' ? 'Available Credits:' : 'Kredit Tersedia:'"></p>
            <span class="font-semibold text-green-600 text-lg" x-text="vcmCredits"></span>
            <span class="ml-2">@ RM50/ton</span>
            <div class="mt-4 flex flex-col sm:flex-row items-center gap-2">
                <input type="number" min="1" :max="vcmCredits" x-model.number="buyAmount" class="border p-2 w-32" placeholder="Tons">
                <button @click="buyCredits(buyAmount)" class="bg-green-500 text-white px-4 py-2">{{ lang === 'en' ? 'Buy Credits' : 'Beli Kredit' }}</button>
            </div>
            <template x-if="errorMessage">
                <p class="text-red-500 mt-2" x-text="errorMessage"></p>
            </template>
            <div class="mt-6">
                <h3 class="font-semibold">{{ lang === 'en' ? 'Purchase History' : 'Sejarah Pembelian' }}</h3>
                <ul>
                    <template x-for="trade in vcmTrades" :key="trade.id">
                        <li>
                            <span x-text="trade.tons"></span> tons - RM<span x-text="trade.cost_rm"></span> (<span x-text="new Date(trade.timestamp).toLocaleDateString()"></span>)
                        </li>
                    </template>
                </ul>
            </div>
        </div>

        <!-- Subscription Model -->
        <div class="bg-white p-6 rounded-lg shadow-lg mt-8 flex flex-col items-center">
            <h2 class="text-xl font-bold mb-2">{{ lang === 'en' ? 'Subscription Plan' : 'Pelan Langganan' }}</h2>
            <p class="mb-2 text-gray-700">{{ lang === 'en' ? 'Unlock unlimited reports for RM50/month.' : 'Buka laporan tanpa had untuk RM50/bulan.' }}</p>
            <button @click="subscribe()" :disabled="premiumUnlocked" class="bg-blue-500 text-white px-6 py-2 rounded disabled:opacity-50">
                {{ premiumUnlocked ? (lang === 'en' ? 'Subscribed' : 'Telah Langgan') : (lang === 'en' ? 'Subscribe RM50/month' : 'Langgan RM50/bulan') }}
            </button>
            <template x-if="showPaymentSuccess">
                <p class="text-green-600 mt-2">{{ lang === 'en' ? 'Subscription successful!' : 'Langganan berjaya!' }}</p>
            </template>
            <template x-if="subscriptionExpiry">
                <p class="text-gray-500 mt-2">{{ lang === 'en' ? 'Expiry:' : 'Tamat:' }} <span x-text="new Date(subscriptionExpiry).toLocaleDateString()"></span></p>
            </template>
            <template x-if="errorMessage">
                <p class="text-red-500 mt-2" x-text="errorMessage"></p>
            </template>
        </div>
    </main>

    <script>
        // Lazy load Chart.js for dashboard graph
        document.addEventListener('DOMContentLoaded', async () => {
            if (document.getElementById('co2eTrendChart')) {
                const Chart = (await import('https://cdn.jsdelivr.net/npm/chart.js')).default;
                const ctx = document.getElementById('co2eTrendChart').getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'CO2e (tons)',
                            data: [],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Time' } },
                            y: { title: { display: true, text: 'CO2e (tons)' } }
                        }
                    }
                });
                Alpine.effect(() => {
                    chart.data.labels = carbonCalculator.pastCalculations.map(calc => new Date(calc.timestamp).toLocaleDateString());
                    chart.data.datasets[0].data = carbonCalculator.pastCalculations.map(calc => calc.co2eTons);
                    chart.update();
                });
            }
        });
        // Lazy load jsPDF for report actions
        window.lazyLoadJsPDF = async () => {
            if (!window.jspdf) {
                const jsPDFModule = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                window.jspdf = jsPDFModule;
            }
        };
    </script>
</body>
</html>